@page "/receitas"
@using FinanceiroPessoal.Aplicacao.DTOs
@using FinanceiroPessoal.Apresentacao.ViewModels
@using FinanceiroPessoal.ViewModels
@inject ReceitaViewModel ReceitaVM
@inject CategoriaViewModel CategoriaVM
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Receitas</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Gerenciar Receitas</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => AbrirModalAdicionar())">
    Adicionar Receita
</MudButton>

<MudTextField @bind-Value="Filtro"
              Placeholder="Buscar..."
              Adornment="Adornment.Start"
              AdornmentIcon="@Icons.Material.Filled.Search"
              Immediate="true"
              Margin="Margin.Dense" />

<MudTable Items="@ReceitasFiltradas" Dense="true" Hover="true" Bordered="true" Striped="true">
    <HeaderContent>
        <MudTh>Descrição</MudTh>
        <MudTh>Valor</MudTh>
        <MudTh>Data</MudTh>
        <MudTh>Categoria</MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>@context.Descricao</MudTd>
        <MudTd>@context.Valor.ToString("C")</MudTd>
        <MudTd>@context.Data</MudTd>
        <MudTd>@CategoriaVM.Categorias.FirstOrDefault(c => c.Id == context.CategoriaId)?.Nome</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                           OnClick="@(() => AbrirModalEditar(context))"
                           Color="Color.Primary" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                           OnClick="@(() => RemoverReceita(context))"
                           Color="Color.Error" />
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {

    public string Filtro { get; set; } = string.Empty;
    private DialogOptions dialogOptions = new() { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };

    public IEnumerable<ReceitaDto> ReceitasFiltradas =>
        string.IsNullOrWhiteSpace(Filtro)
            ? ReceitaVM.Receitas
            : ReceitaVM.Receitas.Where(d =>
                (d.Descricao?.Contains(Filtro, StringComparison.OrdinalIgnoreCase) ?? false)
                || (d.Valor.ToString("C").Contains(Filtro, StringComparison.OrdinalIgnoreCase))
                 || (d.Data?.ToShortDateString().Contains(Filtro) ?? false)
            );

    protected override async Task OnInitializedAsync()
    {
        await CategoriaVM.CarregarCategoriasAsync();
        await ReceitaVM.CarregarReceitasAsync();
        ExibirMensagens();
    }

    private async Task AbrirModalAdicionar()
    {
        var parametros = new DialogParameters
        {
            ["Receita"] = new ReceitaDto { Data = DateTime.Now },
            ["Categorias"] = CategoriaVM.Categorias.Where(c => c.Tipo == Dominio.Enums.TipoCategoria.Receita).ToList(),
            ["ViewModel"] = ReceitaVM
        };

        var dialog = DialogService.Show<ReceitaModal>("Adicionar Receita", parametros, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ReceitaDto nova)
        {
            await ReceitaVM.AdicionarReceitaAsync(new CriarReceitaDto
            {
                Descricao = nova.Descricao,
                Valor = nova.Valor,
                Data = nova.Data,
                CategoriaId = nova.CategoriaId
            });
            ExibirMensagens();
        }
    }

    private async Task AbrirModalEditar(ReceitaDto receita)
    {
        var parametros = new DialogParameters
        {
            ["Receita"] = new ReceitaDto
            {
                Id = receita.Id,
                Descricao = receita.Descricao,
                Valor = receita.Valor,
                Data = receita.Data,
                CategoriaId = receita.CategoriaId
            },
            ["Categorias"] = CategoriaVM.Categorias.Where(c => c.Tipo == Dominio.Enums.TipoCategoria.Receita).ToList(),
            ["ViewModel"] = ReceitaVM
        };

        var dialog = DialogService.Show<ReceitaModal>("Editar Receita", parametros, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ReceitaDto editada)
        {
            await ReceitaVM.AtualizarReceitaAsync(editada.Id, new AtualizarReceitaDto
            {
                Descricao = editada.Descricao,
                Valor = editada.Valor,
                Data = editada.Data,
                CategoriaId = editada.CategoriaId
            });
            ExibirMensagens();
        }
    }

    private async Task RemoverReceita(ReceitaDto receita)
    {
        var parametros = new DialogParameters
        {
            ["Titulo"] = "Confirmação",
            ["Mensagem"] = $"Deseja remover a receita \"{receita.Descricao}\"?",
            ["BotaoConfirmar"] = "Remover",
            ["CorBotaoConfirmar"] = Color.Error
        };

        var dialog = DialogService.Show<DialogoConfirmacao>("Confirmação", parametros, dialogOptions);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await ReceitaVM.RemoverReceitaAsync(receita.Id);
            ExibirMensagens();
        }
    }

    private void ExibirMensagens()
    {
        if (!string.IsNullOrEmpty(ReceitaVM.MensagemErro))
            Snackbar.Add(ReceitaVM.MensagemErro, Severity.Error);

        if (!string.IsNullOrEmpty(ReceitaVM.MensagemSucesso))
            Snackbar.Add(ReceitaVM.MensagemSucesso, Severity.Success);
    }
}
